## CQRS

- CRUD 패턴에서 CUD(command) 와 R 을 구분한다.

- db로 부터 데이터를 읽고 처리하면 그 사이 데이터 변경이 있었을 확률이 크다. 

  따라서, 데이터 변경가능성을 인정하고 CUD와 read 사이 delay를 인정하는 것이다.

- MSA 에서 성능상 이슈와 책임분리를 위해 빈번히 쓰는 패턴

- Event Sourcing과 Queue(AWS SQS , RabbitMQ , Kafka 등) 이용하여 비동기적으로 데이터를 읽고 쓰는 것이 일반적이다. 

  - [참고]([www.youtube.com/watch?v=BnS6343GTkY](https://www.youtube.com/watch?v=BnS6343GTkY))
  
  - 이벤트 전파와 동기화
    - 데이터는 언젠가 다 맞춰진다.
    - 문제발생 시 해당 시스템만 이벤트 재발행
    - 1초~3초 싱크
    - zero-payload : 가게 ID 만 이벤트 보냄
    최신순으로 이벤트 consume한다. 
    이벤트 수신 -> 데이터 바뀐것 (ID) -> API 날려서 확인한다.   
  
  - 데이터 최소 보관 원칙 
  
    - 이벤트 재발행
    - SNS SQS 장애
    1. 전체 import api 제공
    2. 부분 import api 배치용 api 

<br>

## CQRS 패턴의 이점

- read 와 cud 각각에 최적화 된 database를 구성하여 성능을 향상 시킬 수 있다. 
- read로 인한 entity 구조 변경을 막을 수 있다.
  - read와 cud는 각각에 필요한 데이터 형식이 다를 수 있다.
  - read는 aggregation(집계함수) 등 부가적인 attribute들이 entity에 필요할 수 있다.
- 시스템 복잡도를 줄일 수 있다. 과도하게 복잡한 모델을 단순화할 수 있다.

<br> 

## CQRS 패턴을 사용하면 좋은 경우

- 여러 사용자가 동일 데이터에 동시 액세스하는 공동작업도메인
  - CQRS 사용 시 도메인 수준에서 병합 충돌을 최소화하기 위해 세분성 명령 정의 가능
  - 발생하는 충돌은 명령으로 병합 될 수 있다.
- 여러단계 거치거나 복잡한 도메인 모델 사용하는 복잡한 프로세스를 통해 사용자를 안내하는 작업기반 사용자 인터페이스
  - 쓰기모델은 비즈니스 논리, 입력 유효성 검사 , 비즈니스 유효성 검사가 포함된 명령처리 스택
  - 쓰기모델은 연결된 개체 집합을 데이터변경에 대한 단일 단위로 취급한다. 
  - 읽기모델은 비즈니스 논리 또는 유효성 검사 스택이 없다.
  - 읽기모델은 뷰 모델에서 사용할 DTO 반환한다.
- 시스템이 시간이 지나며 진화될 것으로 예상되어 여러버전의 모델을 포함 할 수 있거나 비즈니스 규칙이 정기적으로 변경 되는 시나리오
- 이벤트 소싱과 조합해 다른 시스템과 통합되는 경우. 하위 시스템 중 하나의 일시적 장애가 다른 시스템의 가용성에 영향을 주어선 안된다. 

<br>

## CQRS가 권장 되지 않는 경우

- 도메인 , 비즈니스 규칙이 간단한 경우
- 간단한 CRUD 스타일 사용자 인터페이스 및 데이터 액세스 작업으로 충분한 경우

<br>

### 고려할 사항

- 장애의 격리
- 데이터 동기화
- 확장성 고려



### 구현방법

- read 엔드포인트 따로 만든다
- read replica를 만든다. -> 동기화 문제
- read db 앞에 cache 설정
- 인덱스를 read나 cud에 최적화되도록 설정한다.
- event sourcing 과 함께 Queue를 이용한 비동기적 데이터를 쓰고 읽어오는 형태

<br>

### 이벤트 소싱

- Application 내 모든 Activity를 이벤트로 전환하여 이벤트 스트림을 별도 Database에 저장하는 방식
  - 변경 내역 관리용도는 이벤트 소싱이 적합하다.
- 저장을 위해 DB, 캐시 직접 구현
- kafka와 같은 메시지 큐 이용

- API만 사용하게 되었을때 :  시스템들이 연쇄적으로 장애가 난다. 

### 참고

- [AWS SNS vs SQS](https://btcd.tistory.com/98)

  - AWS SNS : 메세지 전송 관리형서비스, fanout(같은 메시지 여러방향으로 발행)

  - AWS SQS : 메세지 대기열 (Queue) 서비스, decouple  (여러 서비스로 분리해 병렬식 비동기 처리)

- [CQRS & EventSourcing](https://www.popit.kr/cqrs-eventsourcing/)

- 폴리그랏 저장소 : 다수의 database 혼용하여 사용하는 것

